回顾：

1、MixedGC到底是在优化什么？--“避免策略”

2、MixedGC到底是在优化什么？--“提速策略”

3、为什么很少有提升速度相关的调优案例？

 

本节内容：

1、MixedGC参数介绍——堆内存分配相关内容

 

（1）参数-XX:InitiatingHeapOccupancyPercent 默认值为45，也就是45%，这个参数我们前面也有反复提到，它主要的作用就是，当老年代（大对象分区也可以认为是属于老年代）内存占用总空间达到45%之后，才会启动并发标记的任务。

这个值的大小调整需要经过反复的测试，观察，才能调整到最优的比例。假如说这个值过小，比如：30%，那么在经历了一次Mixed GC周期之后，很有可能Mixed GC之后，老年代的占比又快速达到30%，而导致频繁的MixedGC，如果我们调整的过大，比如说70%，虽然说能够避免频繁发生MixedGC，那么年轻代就会频繁YGC，可能会造成新生代的对象频繁触发晋升，有一些没有晋升意义的对象进入老年代。并且，由于YGC的频繁发生，可能会导致处理时间比较长的一些对象贮存在新生代的survivor区，晋升的时候，这个晋升对象的量可能会比较大，同时，因为大量的垃圾对象可能会占满老年代，此时如果发生了晋升失败，会导致full gc发生。

注：在出现晋升失败的时候也会导致full gc

 

如果比较小的情况下，是怎么保证尽量少发生full gc呢？其实很简单，假如说我们设置的比较小20%，那么老年代使用比例很快就会到达这个值，mixed gc触发的频率是不是相对会高很多？只要系统是正常的，没有大量存活对象在老年代，造成空间不够用的这种现像，那么垃圾对象在晋升失败造成的full gc就基本可以避免了。20%意味着，新生代的比例比较高。晋升到老年代的对象可能就不会太多。肯定是大多数请求，都能够正常处理完成就结束了。

20%，触发Mixed GC的标记的时机就是老年代的使用量达到这个值。很快能够进行MixedGC，那是不是只要系统正常，就能在Full gc 之前就把垃圾给处理了。

这个参数不太好设置，所以如果我们要去调节这个参数，可以综合来考虑。目的就是保证YGC，混合GC都比较快，同时full gc比较少。这里可以给大家分享一个经验，就是，如果要设置这个值，可以根据系统运行过程中的“平均使用内存”来设置，把这个值设置的和“平均使用内存”保持一致，或者略高一点都行，这样整体的效率会高一些。

想要观察内存使用情况的话，可以打开我们前面章节里面讲的打印region详情的实验参数:

G1PrintHeapRegions、G1PrintRegionLivenessInfo来观察内存的分配和使用情况。

 

-XX:InitiatingHeapOccupancyPercent这个值设置的好的话，是能极大提升性能的，但是如果想要设置的合理，就需要不断的尝试。

 

 

 

（2）参数-XX:G1ReservePercent 默认值10，也就是10%，这个参数的含义是，在JVM初始化的时候，保留一部分分区不使用，在新生代晋升老年代的时候，给晋升的对象来使用。默认是10%的空间留给新生代对象来晋升。假如说，因为新生代晋升失败导致的full gc比较多，可以适当调大这个值。

这个值的大小，也是和YGC，MixedGC息息相关的，如果值过大，也就意味着，程序正常运行过程中实际可以使用的空间就比较小，那么新生代，老年代可以用的空间就会比较少。而如果这个值过大的话，可能会在晋升过程中，造成晋升失败，YGC使用的比较少，晋升是不是会频繁，比较频繁的话，是不是有可能会导致预留空间，也会快速填满，预留区域不够了，是不是导致full gc。因此这个值一般不做改动，除非我们发现了因为晋升失败导致的full gc比较频繁，比如说，系统一共发生了4次full gc，其中三次产生的导因是发生了晋升失败，那么就可以调大到15%这样子。

 

（3）参数-XX:G1HeapWastePercent 默认5%，这个参数前面我们也有提到过。这个值的含义就是，如果我们开启了并发标记，如果标记结束后，根据CSet中统计出来一个垃圾对象的占比，如果垃圾对象的占比比例（占用整个堆内存）达到了5%以上，就会开启多轮次的MixedGC。如果说统计出来的垃圾对象小于这个值，就不再进行MixedGC，等到下一次的YGC再次进行并发标记（有可能发生）。然后继续上述的逻辑。

这个值其实可以决定MixedGC是否需要执行。换句话来说，就是可以控制MixedGC的频率。如果MiexdGC的频率比较高，同时MixedGC每次回收的垃圾数量不多的话，可以考虑

适当提高这个值。

关于这个参数，曾经在我所在的公司发生过一个真实的案例，因为没什么挑战，我就不详细展开了。具体是这样子的，当时公司在进行优化，G1这块儿的优化是那个小伙伴做的，他当时把这个值调小到了2%，为什么是2%细节就不深入了。

他的思路当时是什么样的呢？大概就是，如果说我把这个值调大了，会降低mixed gc的频率，把它调小了，会增加Mixed GC的频率，如果能增加Mixed GC的频率，并且又不会导致过于频繁的Mixed GC，那么结合“新生代晋升失败”导致full gc的这个条件，就可以降低full gc发生的频率。

 

出发点确实很好，但是他忽略了一个点，我们当时的系统对rt的要求是非常高的，所以在这个系统的一些优化上，我们已经做到了基本不发生Full gc。

但是MixedGC还是会时有发生，他这一统操作，直接导致我们的Mixed GC发生频率直线上升。系统反而rt响应会出现抖动。

所以，这个值在设置的时候，需要考虑的因素，也是比较多的。不能盲目，也不能想当然的去设置