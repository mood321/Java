回顾：

1、案例背景

业务背景：一个小时购电商系统的缓存服务。

![picture.png](http://wechatapppro-1252524126.cdn.xiaoeknow.com/apppuKyPtrl1086/image/ueditor/56670700_1646623993.png?imageView2/2/q/80%7CimageMogr2/ignore-error/1)

2、问题现场

请求响应时间非常长。

![picture.png](http://wechatapppro-1252524126.cdn.xiaoeknow.com/apppuKyPtrl1086/image/ueditor/57873300_1646623993.png?imageView2/2/q/80%7CimageMogr2/ignore-error/1)

3、redis缓存有啥问题？

锁持有时间太长。

4、缓存同步服务有啥问题？

大量的Mixed GC出现。并且Mixed GC持续的时间非常长，且频率非常高，基本上是10分钟就要进行一轮Mixed GC，每一轮，基本上都要跑满8次（我们线上环境设置的参数，就是8次）这就导致了超时的问题出现。

5、线上环境的参数设置及调优

-XX:InitialHeapSize=20G -XX:MaxHeapSize=20G -Xss1M -XX:+UseG1GC -XX:SurvivorRatio=8 -XX:MaxGCPauseMillis=300 -XX:G1HeapRegionSize=4M -XX:MaxTenuringThreshold=15 -XX:InitiatingHeapOccupancyPercent=30

 

问题点：regionSize太小造成大量大对象进入humongous区域，造成频繁MixedGC，回收效率不高，又导致缓存同步逻辑被阻塞。

如何调优？

第一步：就是把region调大，调回到16MB

第二步：修改代码，把job补偿的频率调的低一点儿，同时把job每次处理的数据量调小一点。第三步：修改新生代初始比例。调整为25。

 

 

本节内容：

1、MixedGC到底是在优化什么？--“避免策略”

前面我们讲了YGC，MixedGC的原理，同时结合生产案例讲解了一些优化的过程以及优化思路。其实不难发现，真实在公司中的优化思路主要的优化点都是在于避免过多发生GC，或者通过代码的修改，参数的调整来间接调整YGC，或者MixedGC的持续时间，发生频率来提高系统的性能。

例如我们YGC的案例，调整RegionSize TLAB Size，避免大对象分配，避免走堆分配。

在MixedGC的案例里面，调整regionsize 新生代大小，以及代码逻辑来提升处理速度，减少MixedGC发生的概率。

这两个场景都是我们通过“避免”的思路来做的优化。避免的优化思路其实很重要。对于“避免”的思路，我们做一些优化总结：

（1）避免什么？如何避免？

第一，要避免“慢操作”。首当其冲的就是分配操作，要避免慢速分配。——RegionSize的大小，TLAB的大小，refill_waste的设置，工作线程数量等等这些都是避免慢速分配的一些相关的可调参数。

第二，要避免“慢回收”。说白了就是Miexd GC我们是要尽可能避免的，因为速度比较慢。——RegionSize，新生代比例，老年代占比阈值，停顿时间等等，这些都是慢回收的一些相关可调参数。

这两个避免，也是我们日常工作中需要关注的重点调优点。大多数的调优思路都是来源于此。

2、MixedGC到底是在优化什么？--“提速策略”

除了避免的策略，那么接下来要做到性能的机制优化，就只能从分配、标记、回收、回收过程中的各种复杂操作来提升处理的速度，来达到提升性能的目的了。

（1）提什么速？怎么提速？

第一，提升分配速度，这个和我们上面的避免慢速分配有异曲同工之妙主要要操作的就是和TLAB相关的一些参数，再我们调大了TLAB，调整的refill_waste之后，基本上可以避免对象分配走慢速分配了。在此基础之上，我们还需要关注JVM之外的一些内容其中比较重要的就是，工作线程的数量，如果服务器是16C这种高性能机器，搞个几百个线程其实问题不大，但是如果是4C这种服务器，你要是搞几百个线程处理请求，很显然就不合适了，这样即使你TLAB相关的参数调整的再好，分配的效率也还是会很低。所以提速主要就是根据服务器来确定工作线程的数量。

第二，提升回收的速度。提升回收的速度其实也是一个很大的主题。比如在YGC阶段，参与回收的线程数量、DCQ相关白绿黄红四个区域设定、DCQ的长度设置、PLAB的大小设置都是一些提升回收速度的手段。在服务器可承受的情况下，提升参与的线程数，肯定能提升回收效率，白绿黄红区域的阈值设置的合理也能在一定程度上减少GC过程中的处理压力，减少GC的总时间。PLAB缓冲区的设置如果足够充裕，也能够保证更快的回收（当然也可能会造成比较多的内存碎片，这个点儿依然是需要做很多权衡）。在MixedGC阶段，SATB队列的长度：GCDrainStackTargetSize，并发标记阶段处理时，一次标记的最多对象个数，GC一次最多选择多少个分区进行回收，剩余多少垃圾时停止MixedGC回收等参数，都是提升GC效率的一些重要参数。

 

3、为什么很少有提升速度相关的调优案例？

 

其实提升速度的案例基本上很少遇到，除非你是做一些基础架构的中间件儿，对性能有非常非常细微的要求，才可能会接触到提升速度相关的优化。比如我们上面说的一些基本很少见过的冷门参数，我们正常的业务系统根据达不到从这些参数层面上下手优化的程度。

 

下节课，我们来了解一下，如何去做一些提速层面的优化。