回顾：

Mixed回收的整体流程图

![picture.png](http://wechatapppro-1252524126.cdn.xiaoeknow.com/image/ueditor/13846000_1641818476.png?imageView2/2/q/80%7CimageMogr2/ignore-error/1)

1、性价比怎么计算？

2、回收时间是什么？

3、如何统计回收时间？

4、停顿预测模型结合统计排序选择Collect Set

5、总结

 

本节内容：

1、被选中的CSet

上节课我们已经知道了Collect Set到底是什么了。以及它究竟是怎么被选出来的。说白了就是按照回收的速度快慢，把region做了一下排序，从中选择了一部分分区作为CSet。

但是我们要明白的是，MixedGC本身，是包含了YGC的，所以在选择region的时候，一定是包含了所有的新生代的分区的。虽然，在混合回收的时候，第一个阶段初始标记阶段，YGC已经完成了对新生代的回收，但是本质上，一次混合回收，选择的分区还是新生代所有分区，以及老年代的部分分区。

另外还需要注意一点的是，在这个阶段被选中的region，一定没有一个region是全部都是垃圾的。因为这些分区在预清理阶段已经被清理掉了。

那么剩下的分区，我到底选择多少才合适？全部都选上肯定是不可能的，从G1的特性思考就知道不可能。那么选择性价比高的又应该选择多少？

 

2、XX:G1MixedGCLiveThresholdPercent参数

这个参数决定了，是否可以把一个region加入到CSet集合中。

这个参数的含义是，如果一个分区的存活对象占这个region分区的比例大于或者等于XX:G1MixedGCLiveThresholdPercent的时候，就不加入到CSet中，反之，如果小于这个值就会加入到CSet中。

XX:G1MixedGCLiveThresholdPercent的默认值是85%，也就是，如果存活对象大于，或者等于85%region的大小，那么这个region就不值得回收。回收价值太低了。因为大量的对象需要被复制到新的分区，需要做大量复杂的操作，腾出来的空间却很小。

 

3、混合回收是否要执行的条件

 

我们知道混合回收真正的执行，是在并发标记之后，才会对分区进行垃圾回收。其实在真正执行垃圾回收前，还需要做一层额外的判断。

注意：这个判断和是否开启并发标记的判断不是一个意思！这个判断是发生在并发标记之后，决定是否要开始回收的一个判断条件。

这个判断由一个参数控制：XX:G1HeapWastePercent 默认5%，即，在并发标记结束之后，如果说我们选择的CSet中可以被回收的垃圾占用总堆内存空间的占比大于5%，才会开始混合回收的回收阶段，否则本次是不开启垃圾回收的过程的。即使并发标记，重新标记都已经完成，也不开启垃圾回收的过程。

 

4、MixedGC的最后一步，垃圾回收过程

在判断通过之后，就会进入这最后一步的回收过程。这个过程因为要控制停顿时间，所以，G1会分开多次执行。具体几次也是由一个参数控制：

XX:G1MixedGCCountTarget，默认为8，也就是说，混合回收的过程，会对CSet进行分批次回收，最多分成8次来完成混合回收。也就是说，假如我们的CSet总计有400个region，每次为了满足停顿时间（假设100ms），发现只能回收50个（因为按照region的性价比排序，所以可能每次能回收的个数不一定是50），那么就会按照每次50个左右的region来进行回收。

当然，这个8次是不一定会完全进行到底的。当我们分批次回收的时候，会判断要不要进行下一次回收，判断的条件，还是XX:G1HeapWastePercent，也就是回收一次，判断一下CSet里面的垃圾对象占用的空间是否大于堆内存的5%，如果小于，就停止混合回收，本次回收就彻底结束。如果大于，则继续进行。

如果说，CSet里面的region非常多，那一次选择的region也非常多，咋办？1000个之多，怎么办？

 

5、分批次回收选择的region个数限制

G1OldCSetRegionThredShouldPercent，这个参数默认是10，表示，每次在执行混合回收的时候，回收掉的分区数量不能超过整个堆内存分区数量的10%。也就是说，假如说我们分了8次进行回收，结果发现某一次回收的时候，准备300个分区，而此时堆内存总共才2000个分区，那么此时，是不会回收300个分区，而是只会回收200个分区