回顾：

Mixed回收的整体流程图

![picture.png](http://wechatapppro-1252524126.cdn.xiaoeknow.com/image/ueditor/79225100_1641818344.png?imageView2/2/q/80%7CimageMogr2/ignore-error/1)

面试题：G1选择collect Set的算法是什么？

 

1、性价比怎么计算？

我们一直在说的一个观点就是，选择region，会选择回收性价比最高的region。那性价比到底怎么计算？

简单来说，就是回收一个region，所需要的时间和回收掉的垃圾，做一个除法。比如说，一个reigon 总计32MB，能够回收掉的垃圾是20MB，回收需要1ms，那么我们就可以说，它的回收价值是 20MB/1ms，性价比高不高怎么算？是不是我们只要有一个排序就知道了。

假如说，一个region是10 MB/ 1ms，那肯定回收的性价比要低一点。

 

2、回收时间是什么？

可回收垃圾的数量，我们通过位图就可以统计（位图标记了对象的存活状态，同时也描述了对象占用空间的大小），那回收时间到底怎么确定呢？

实际上，对于这个回收时间，我们应该用一个更加准确的说法。叫做，存活对象转移时间。

什么意思呢？不管是YGC还是MixedGC，采取的都是把存活对象复制一个空闲的新分区，然后释放老分区，加入到空闲分区列表中。那么真正耗时的，是不是就是这个对象复制的过程？因为对象复制涉及到了对象本身，对象数据，对象头更新，引用关系的指向更新，RSet，卡表等等一系列的更新。这个过程是非常非常耗时的。如果这个过程做完了以后，原本的region里面我们可以认为它都是垃圾对象，此时直接一股脑全部释放掉，基本上不会耗费什么时间。

所以真正决定回收时间的，其实就是对象转移时间。也可以认为region回收需要的时间 = 对象转移时间。

 

3、如何统计回收时间？

大家还记不记得停顿预测模型？我们知道它在每次GC的时候，都会对整个GC耗费的时间，回收的垃圾数量进行一个统计，用来预测下一次GC的时候，我应该选择多少分区，回收多少对象？

实际上，这个预测模型，预测内容和我们所说的对象转移效率，基本上是同一个东西。那么结合这个停顿预测模型，预测出来的，我的回收能力（对象转移效率），回收能力，其实就是你单位时间内能够回收多少垃圾。就可以分析出，我到底能够以什么样的能力去回收一个region。以此为基准我们是不是就可以去做Collect Set的选择了？

我有一个垃圾回收的能力预测值，然后我再看看垃圾有多少，我怎么选择。

简单说明一下对象转移的效率，如果说一个region中的存活对象很多，那它的转移效率一定会比较低。因为需要转移的对象很多。

反过来说，里面的垃圾对象很少，如果要回收这个region，我首先需要把里面大量的存活对象复制到一个空闲分区，然后执行一系列RSet , 卡表，对象引用更新等等的操作。然后才能回收掉一丢丢的垃圾，这样在的回收时间，一定非常长。

 

大家看这张图，有三个region，很明显，第一个region存活对象只有一个，转移起来会比较容易。耗费的时间最短。中间的region，转移起来会非常麻烦，耗费的时间最长。

![picture.png](http://wechatapppro-1252524126.cdn.xiaoeknow.com/image/ueditor/74648100_1641818344.png?imageView2/2/q/80%7CimageMogr2/ignore-error/1)

 

4、停顿预测模型结合统计排序选择Collect Set

 

由上面的内容其实我们也可以理解了，所谓的选择Collect Set的算法，其实就是结合停顿预测模型来计算出转移对象的效率，也就是对象回收的效率。再根据我们在混合回收的预回收阶段做的region的垃圾对象、存活对象的内存占用统计排序，就可以选择出我们需要回收的region。

简单来说就是，垃圾对象占比越高的Region，回收的效率就越高。而Collect Set的选择算法，也非常简单粗暴，就是选择垃圾对象最多的那些region来回收。

 

如下图所示，在最终标记阶段之后，会把所有的region都做一下排序，垃圾对象最多的region，就会排到最前面，那么回收的时候优先选择的就是这些垃圾对象最多的分区。

![picture.png](http://wechatapppro-1252524126.cdn.xiaoeknow.com/image/ueditor/75728700_1641818344.png?imageView2/2/q/80%7CimageMogr2/ignore-error/1)

 

5、总结

在回答这个问题的时候，首先要说明的就是回收性价比。

而回收性价比的计算，其实就是，单位时间内能够回收多少垃圾。能够回收的越多，就代表性价比越高。

而在region中有对象转移效率这个概念，在停顿预测模型中（衰减标准差算法），可以预测我的回收能力，其实这个回收能力就代表了一个region存活对象的转移效率。

那么我在选择region的时候，就基于并发标记阶段的标记内容，以及最终标记阶段对region存活对象的统计，按照存活对象数量多少，来选择region，存活对象越少，就排的越靠前