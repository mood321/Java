本节内容：

1、什么叫快速分配？什么叫慢速分配？

2、慢速分配是什么？有几种情况？

 

1、什么叫快速分配？什么叫慢速分配？

快速分配和慢速分配本身没有什么太高深的含义，通俗来讲就是分配对象速度快、流程少的就叫做快速分配，分配对象慢，流程多的就叫做慢速分配。

 

所谓的快速分配，其实就是我们上节课讲到的，**TLAB****分配对象**的过程就叫做**快速分配**，之所以叫他快速分配，是因为，多个线程，直接通过自己的TLAB就可以分配对象，不需要加锁，直接就可以完成多个线程并行去创建对象，没有加锁的过程。

第一：创建快

第二：并发度高

第三：无锁化

![picture.png](http://wechatapppro-1252524126.file.myqcloud.com/image/ueditor/62949100_1640327848.png)

思考：为什么这叫快速分配？

上节课我们讲了，因为这样子分配，相当于无锁化分配了，并且多个线程可以并发的去执行对象分配的操作。我们看下面这张图：

![picture.png](http://wechatapppro-1252524126.file.myqcloud.com/image/ueditor/63461600_1640327848.png)

 

而慢速分配，其实也简单，没有办法走快速TLAB分配的就是慢速分配，因为慢速分配需要加锁，甚至可能要涉及到GC的过程，所以速度非常慢，我们称之为慢速分配。

如果说，不走TLAB分配，是不是也相当于，没走快速TLAB分配。

![picture.png](http://wechatapppro-1252524126.file.myqcloud.com/image/ueditor/64765300_1640327848.png)

整个对象分配流程如下：

（1）TLAB剩余内存太小，无法分配对象，会有不同情况，要么是大于refill_waste，直接走堆内存分配，不走TLAB了，要么是小于refill_waste，但是TLAB剩余内存空间不够，这个时候会重新分配一个TLAB来用。

（2）如果无法分配新的TLAB，这个过程CAS分配一块儿TLAB，如果说失败。就会进入堆加锁分配，再去分配一个TLAB。如果说能够分配成功，就可以直接在TLAB分配对象，那么就万事大吉。

（3）如果不能分配，此时就会尝试去扩展分区，也就是再申请一些新的region，成功扩展了region，就分配TLAB，然后分配对象，如果不成功就会走垃圾回收。

（4）如果分配尝试的次数超过了某个阈值（默认为2次），就直接结束，OOM。

 

思考：根据上面的图思考，什么情况下，会出现慢速分配，有几种慢速分配的情况？

 

2、慢速分配是什么？有几种情况？

慢速分配其实和快速分配相比起来就是多了一些流程，在**对象创建**这个层面上是**没有效率区别**的。慢速之所以称为慢速，是因为我们在分配对象的时候，需要去申请内存空间，需要加锁等等一系列耗时的操作，并且除了加锁，还可能涉及到垃圾回收的过程。

那么慢速分配大概是有两种情况：

（1）本来走TLAB，但是TLAB空间不够，要重新申请TLAB，并且TLAB初步申请还失败了

这种情况，也就是说，refill_waste这一关已经过了，TLAB中对象太多，导致对象放不下？此时会触发新创建TLAB，然后可能会进入慢速分配。

这个过程的慢速分配是指：慢速分配一个TLAB

 

（2）上来判断就无法走TLAB，只能走堆内存分配对象

第二种，对象太大，refill_waste这一关直接没过，导致不走TLAB分配，此时会触发慢速分配，并且不是去申请TLAB，而是直接进入慢速分配。直接在堆内存，也就是eden区去分配对象。

这个过程的慢速分配是指：慢速分配一个对象。

![picture.png](http://wechatapppro-1252524126.file.myqcloud.com/image/ueditor/61078600_1640327848.png)

针对第一种情况，有两种慢速分配的两种场景

（1）就是通过TLAB分配的时候，在分配新的TLAB失败之后的过程就进入慢速分配TLAB

也就是说，经过CAS分配也没成功，就只能去尝试拓展新生代，经过了GC再次分配一个TLAB的过程

![picture.png](http://wechatapppro-1252524126.file.myqcloud.com/image/ueditor/64269200_1640327848.png)

第二种场景，其实就是直接没办法走TLAB了。此时慢速分配和前面的流程基本相似，但是有一个点不太相同的是，第一种场景在尝试通过堆内存分配的时候，分配的还是TLAB，而无法走TLAB分配虽然流程完全一样，但是分配的是对象。

所以说，TLAB方式进入慢速分配，是第一次分配TLAB失败，进入一个慢速分配TLAB的的过程。

更慢的慢速分配，是TLAB尽力尝试以后，还是无法分配，只能再次进入堆内存慢速分配的过程，两个都叫做慢速分配。

 

思考一个问题：我们一直在说普通对象的分配，默认认为对象在TLAB中是放的下的，那么如果有一个大对象，TLAB根本放不下怎么办？此时的对象分配是快速还是慢速？