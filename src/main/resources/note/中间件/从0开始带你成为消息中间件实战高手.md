
> 从0开始带你成为消息中间件实战高手 的笔记



### 01 一个真实电商订单系统的整体架构、业务流程及负载情况

#### 一个订单系统的业务流程

<img src="https://s1.ax1x.com/2020/07/20/U4vBKH.jpg" alt="U4vBKH.jpg" border="0" />


####   一个订单系统的非核心流程
<img src="https://s1.ax1x.com/2020/07/20/U4xISO.jpg" alt="U4xISO.jpg" border="0" />

### 02 授人以渔：能概括一下你们系统的架构设计、业务流程以及负载情况吗？
> 首先你得知道现在你的系统，或者行业里其他普遍的一些系统，都有哪些技术难点和痛点，面临哪些问题。

>  接着要针对这些问题，反过来去学习一个技术，学习完这个技术之后，一定要思考如何将技术代入到真实的环境中，
  去解决对应的问题。
  
### 03 系统面临的现实问题：下订单的同时还要发券、发红包、Push推送，性能太差！

> 系统的压力来自哪

+ 电商这种系统,用户都会集中在晚上几个小时,为什么就不分析了, 他的访问曲线不是平均的,而是集中在一起的

<img src="https://s1.ax1x.com/2020/07/20/U5SORf.jpg" alt="U5SORf.jpg" border="0" />

+ 这种架构的压力都会落在单点上,上图就是mysql, 依据经验 4核8g mysql 最好1000-1500 能2000,16核32SSD 1万应该是极限,可能会出问题

+ 上面业务的问题, 在流程8中 ,支付回调中 ,推送,优惠券等,会有大量业务,太耗时


### 04 授人以渔：你们系统的核心流程性能如何？有没有哪个环节拖慢了速度？
> 普通项目还是业务处理和sql

> rpc 和第三方接口调用 ,同步的

要思考，在当前这样的系统压力下：

+ 系统的核心业务流程性能如何？
+ 核心流程的每个步骤要耗费多长时间？
+ 现在核心流程的性能你满意吗？是否还有优化的空间？
+ 在系统高峰期的时候，机器和数据库负载很高，是否对核心流程的性能有影响？
+ 如果有影响的话，会有多大的影响？

那你就想，你的这个系统做一个SaaS云平台的模式，提供给几万个公司，百万用户使用，不就可以了？你要自己去模拟这个场景。

然后，你按照文中的思路去推算出系统高峰期的负载，以及你的线上系统的机器的压力，到底要部署多少机器去满足这个压力。 


### 05 系统面临的现实问题：订单退款时经常流程失败，无法完成退款！
> 退款流程

<img src="https://s1.ax1x.com/2020/07/20/U5Fwxx.jpg" alt="U5Fwxx.jpg" border="0" />

+ 问题一: 和下单一样,流程过长  

+ 问题二: 如果退款失败怎么办

+ 下单之后不付款怎么办
> 下单之后会占用库存, 不付款 ,别人也买不了这个商品

给这种订单一个超时时间,超过 取消订单

+ 如果 下单之后不付款的单子 巨多,怎么处理
> 不停地去扫描表  效率太差,占用太多资源


### 06 授人以渔：你们系统出现过核心流程链路失败的情况吗？
> low 系统..

假设下 如果失败,可以保存失败操作,开始重试

### 07 系统面临的现实问题：第三方客户系统的对接耦合性太高，经常出问题！
> 还是上面的 订单支付 流程

+ 还是流程中有很多对接的第三方系统 ,比如支付,库仓 发货

<img src="https://s1.ax1x.com/2020/07/20/U5EDs0.jpg" alt="U5EDs0.jpg" border="0" />


+ 积分,发货,优惠券等系统都是和订单系统耦合在一起的

+ 这样订单系统和第三物流系统 也算耦合到一起, 会带来不确认性, 会基于网络,第三方系统大量原因导致 性能差

### 08 授人以渔：你们有没有跟第三方系统对接过，有遇到什么问题吗？
> 同步调第三方系统 真的一言难尽,  会各种坑, 随时保存日志,记得甩锅

### 09 系统面临的现实问题：大数据团队需要订单数据，该怎么办？

#### 大数据到底是干嘛的？
> 通过实时 采集来的数据,分析用户行为和其他结论 

每天如果有100万用户来访问你的APP，积累下来的一些浏览行为、访问行为、交易行为都是各种数据，这个数据量很大，所以你可以称之为“大数据”

大数据团队每天要负责的事情，说白了就是去尽可能的搜集每天100万用户在你的APP上的各种行为数据。

#### 大数据与我们系统的关系
> 订单数据等  他们需要分析每天几十万个订单，从中提取出老板最关心的APP交易数据报表！ 

方法

   +   select 查询
       
        大sql  而且查询次数不低,  数据库的cpu 和io 占用会很高, 其他操作就效率很低了
        

### 10 授人以渔：你们有没有遇到过自己系统的数据，其他团队需要获取的？
> 没有 

假设有, 比如微服务 过来取数据, 加缓存( 可以是缓存,也可以是新表), 异步同步  查询走缓存 

### 11 系统面临的现实问题：秒杀活动时数据库压力太大，该怎么缓解？

> 上面系统的缺点 是同步流程太长,效率太差

 假如在平时晚上的高峰使用期，最顶峰的时候大概是每秒2000左右的请求压力到订单系统上来。
 
 如果用户每秒会发起2000个请求到我们的订单系统的各类接口，包括下单接口、退款接口、查询接口等等，那么你觉得我们的订单系统每秒会执行多少条SQL在订单数据库上？
 
 一般你可以认为平均每个接口会执行2~3次的数据库操作。
 
 一般一个接口根据业务复杂度的不同，有的接口可能处理一个请求要执行五六次数据库操作，有的接口可能是1次数据库操作+两三个其他系统的接口调用（比如库存系统、营销系统）。

 总之，一般来说，业务系统的接口处理逻辑，基本都集中在对自己的数据库的操作以及对其他系统的调用上
 
 
#### 双11之类的大促活动有多恐怖

如果有200万用户参与双11活动，在双11购物最高峰的时候，假设会达到每秒至少1万的QPS。

也就是说，光是系统被请求的QPS就会达到1万以上，那么系统请求数据库的QPS就会达到2万以上。16核32G SSD 数据库性能，是无论如何扛不住每秒2万请求的。 

### 12 授人以渔：你们系统会不会遇到流量洪峰的场景，导致瞬时压力过大？
> 没有

假设有,异步处理, mq 削峰,  失败了就  开重试 ,最大重试次数还是失败  ,取消吧










